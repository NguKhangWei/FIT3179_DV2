<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IMO Visualizations</title>
  <script src="https://cdn.jsdelivr.net/npm/vega@6"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #vis-map, #vis-treemap { width: 100%; height: 80vh; margin-bottom: 50px; }
  </style>
</head>
<body>
  <h2>IMO Participation Choropleth Map</h2>
  <div id="vis-map"></div>

  <h2>Treemap Example</h2>
  <div id="vis-treemap"></div>

  <script type="text/javascript">
    // ---- Choropleth Spec ----
    const mapSpec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "title": "International Math Olympiad Participation Count by Country (1959 to 2024)",
      "width": "container",
      "height": "container",
      "projection": { "type": "equalEarth" },
      "layer": [
        {
          "data": { "sphere": true },
          "mark": { "type": "geoshape", "fill": "#cce5f5" }
        },
        {
          "data": { "graticule": true },
          "mark": { "type": "geoshape", "stroke": "gray", "strokeWidth": 0.25 }
        },
        {
          "data": {
            "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/3_choropleth_map/js/ne_110m_admin_0_countries.topojson",
            "format": { "type": "topojson", "feature": "ne_110m_admin_0_countries" }
          },
          "transform": [
            {
              "lookup": "properties.NAME",
              "from": {
                "data": {
                  "url": "https://raw.githubusercontent.com/NguKhangWei/FIT3179_DV2/data/modified_country.csv",
                  "format": { "type": "csv" }
                },
                "key": "country",
                "fields": ["count"]
              }
            },
            {
              "calculate": "datum.count == null ? 0 : datum.count",
              "as": "count"
            }
          ],
          "mark": { "type": "geoshape", "stroke": "white", "strokeWidth": 0.5 },
          "encoding": {
            "color": {
              "field": "count",
              "type": "quantitative",
              "scale": {
                "type": "threshold",
                "domain": [15, 30, 45],
                "range": ["#deebf7", "#9ecae1", "#4292c6", "#084594"]
              },
              "legend": { "title": "Number of Participations" }
            },
            "tooltip": [
              { "field": "properties.NAME", "type": "nominal", "title": "Country" },
              { "field": "count", "type": "quantitative", "title": "Number of Participations" }
            ]
          }
        }
      ],
      "config": {
        "title": { "fontSize": 24, "anchor": "middle", "fontWeight": "bold" }
      }
    };

    // ---- Treemap Spec ----
    const treemapSpec = {
      "$schema": "https://vega.github.io/schema/vega/v6.json",
      "description": "An example of treemap layout for hierarchical data.",
      "width": 960,
      "height": 500,
      "padding": 2.5,
      "autosize": "none",

      "signals": [
        {
          "name": "layout", "value": "squarify",
          "bind": {
            "input": "select",
            "options": [
              "squarify",
              "binary",
              "slicedice"
            ]
          }
        },
        {
          "name": "aspectRatio", "value": 1.6,
          "bind": {"input": "range", "min": 1, "max": 5, "step": 0.1}
        }
      ],

      "data": [
        {
          "name": "tree",
          "url": "https://vega.github.io/editor/data/flare.json",
          "transform": [
            {
              "type": "stratify",
              "key": "id",
              "parentKey": "parent"
            },
            {
              "type": "treemap",
              "field": "size",
              "sort": {"field": "value"},
              "round": true,
              "method": {"signal": "layout"},
              "ratio": {"signal": "aspectRatio"},
              "size": [{"signal": "width"}, {"signal": "height"}]
            }
          ]
        },
        {
          "name": "nodes",
          "source": "tree",
          "transform": [{ "type": "filter", "expr": "datum.children" }]
        },
        {
          "name": "leaves",
          "source": "tree",
          "transform": [{ "type": "filter", "expr": "!datum.children" }]
        }
      ],

      "scales": [
        {
          "name": "color",
          "type": "ordinal",
          "domain": {"data": "nodes", "field": "name"},
          "range": [
            "#3182bd", "#6baed6", "#9ecae1", "#c6dbef", "#e6550d",
            "#fd8d3c", "#fdae6b", "#fdd0a2", "#31a354", "#74c476",
            "#a1d99b", "#c7e9c0", "#756bb1", "#9e9ac8", "#bcbddc",
            "#dadaeb", "#636363", "#969696", "#bdbdbd", "#d9d9d9"
          ]
        },
        {
          "name": "size",
          "type": "ordinal",
          "domain": [0, 1, 2, 3],
          "range": [256, 28, 20, 14]
        },
        {
          "name": "opacity",
          "type": "ordinal",
          "domain": [0, 1, 2, 3],
          "range": [0.15, 0.5, 0.8, 1.0]
        }
      ],

      "marks": [
        {
          "type": "rect",
          "from": {"data": "nodes"},
          "interactive": false,
          "encode": {
            "enter": {
              "fill": {"scale": "color", "field": "name"}
            },
            "update": {
              "x": {"field": "x0"},
              "y": {"field": "y0"},
              "x2": {"field": "x1"},
              "y2": {"field": "y1"}
            }
          }
        },
        {
          "type": "rect",
          "from": {"data": "leaves"},
          "encode": {
            "enter": {
              "stroke": {"value": "#fff"}
            },
            "update": {
              "x": {"field": "x0"},
              "y": {"field": "y0"},
              "x2": {"field": "x1"},
              "y2": {"field": "y1"},
              "fill": {"value": "transparent"}
            },
            "hover": {
              "fill": {"value": "red"}
            }
          }
        },
        {
          "type": "text",
          "from": {"data": "nodes"},
          "interactive": false,
          "encode": {
            "enter": {
              "font": {"value": "Helvetica Neue, Arial"},
              "align": {"value": "center"},
              "baseline": {"value": "middle"},
              "fill": {"value": "#000"},
              "text": {"field": "name"},
              "fontSize": {"scale": "size", "field": "depth"},
              "fillOpacity": {"scale": "opacity", "field": "depth"}
            },
            "update": {
              "x": {"signal": "0.5 * (datum.x0 + datum.x1)"},
              "y": {"signal": "0.5 * (datum.y0 + datum.y1)"}
            }
          }
        }
      ]
    };

    // ---- Render both ----
    vegaEmbed("#vis-map", mapSpec);
    vegaEmbed("#vis-treemap", treemapSpec);
  </script>
</body>
</html>
